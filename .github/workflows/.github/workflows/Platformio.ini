```cpp
#include <Arduino.h>
#include <M5Cardputer.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <Update.h>
#include <ArduinoJson.h>
#include <IRremoteESP8266.h>
#include <IRsend.h>
#include <IRrecv.h>
#include <EEPROM.h>
#include <vector>
#include "config.h"

// ================================================
// ULTIMATUM SKELETON KEY FOR M5STACK CARDPUTER ADV
// ================================================

// Display instance
M5Canvas canvas(&M5Cardputer.Display);
```

// IR instances
IRrecv irrecv(IR_RECV_PIN);
IRsend irsend(IR_TX_PIN);
decode_results ir_results;

// Application States
enum AppState {
  SPLASH_SCREEN,
  MAIN_MENU,
  RFID_CLONER,
  IR_BLASTER,
  IR_LEARN,
  WIFI_SCANNER,
  WIFI_DEAUTH,
  BLUETOOTH_SCANNER,
  SIGNAL_ANALYZER,
  AI_ASSISTANT,
  FIRMWARE_UPDATE,
  SETTINGS,
  ABOUT
};

AppState currentState = SPLASH_SCREEN;

// Menu Configuration
const char* menuItems[] = {
  "RFID Cloner",
  "IR Blaster",
  "IR Learner",
  "WiFi Scanner",
  "WiFi Deauth",
  "Bluetooth Scan",
  "Signal Analyzer",
  "DeepSeek AI",
  "Firmware Update",
  "Settings",
  "About"
};

int currentMenuIndex = 0;
const int menuItemCount = 11;

// WiFi Configuration
struct WiFiConfig {
  char ssid[32];
  char password[64];
} wifiConfig;

// AI Configuration
struct AIConfig {
  char apiKey[64];
  char model[32];
  char endpoint[128];
} aiConfig;

// IR Code Storage
struct IrCode {
  uint32_t value;
  uint16_t bits;
  uint8_t protocol;
  char name[20];
};
std::vector<IrCode> irCodes;

// Global Variables
String firmwareVersion = FIRMWARE_VERSION;
bool updateAvailable = false;
String aiResponse = "";
bool aiThinking = false;

// ================================================
// INITIALIZATION
// ================================================

void setup() {
  // Initialize M5Cardputer
  auto cfg = M5.config();
  M5Cardputer.begin(cfg);
  M5Cardputer.Display.setRotation(1);
  M5Cardputer.Display.setTextSize(1);
  
  Serial.begin(115200);
  Serial.println("\n================================");
  Serial.println("ULTIMATUM SKELETON KEY v" + firmwareVersion);
  Serial.println("M5Stack Cardputer ADV");
  Serial.println("================================\n");
  
  // Initialize EEPROM
  EEPROM.begin(EEPROM_SIZE);
  
  // Initialize IR
  irrecv.enableIRIn();
  irsend.begin();
  
  // Load configurations
  loadConfigurations();
  
  // Show splash screen
  showThunderCastleSplash();
  
  // Initialize WiFi if configured
  if (strlen(wifiConfig.ssid) > 0) {
    connectToWiFi();
  }
  
  // Show main menu
  currentState = MAIN_MENU;
  showMainMenu();
}

void loop() {
  M5Cardputer.update();
  
  switch (currentState) {
    case MAIN_MENU:
      handleMainMenu();
      break;
    case IR_BLASTER:
      handleIRBlaster();
      break;
    case IR_LEARN:
      handleIRLearn();
      break;
    case WIFI_SCANNER:
      handleWiFiScanner();
      break;
    case WIFI_DEAUTH:
      handleWiFiDeauth();
      break;
    case BLUETOOTH_SCANNER:
      handleBluetoothScanner();
      break;
    case AI_ASSISTANT:
      handleAIAssistant();
      break;
    case FIRMWARE_UPDATE:
      handleFirmwareUpdate();
      break;
    case SETTINGS:
      handleSettings();
      break;
    case ABOUT:
      handleAbout();
      break;
    default:
      currentState = MAIN_MENU;
      showMainMenu();
      break;
  }
  
  delay(10);
}

// ================================================
// DISPLAY FUNCTIONS
// ================================================

void showThunderCastleSplash() {
  M5Cardputer.Display.fillScreen(BLACK);
  
  // Draw castle
  M5Cardputer.Display.fillRect(60, 40, 120, 60, WHITE);
  M5Cardputer.Display.fillRect(80, 20, 20, 30, WHITE);
  M5Cardputer.Display.fillRect(140, 20, 20, 30, WHITE);
  
  // Draw thunder bolt
  M5Cardputer.Display.drawLine(120, 10, 110, 25, YELLOW);
  M5Cardputer.Display.drawLine(110, 25, 120, 35, YELLOW);
  M5Cardputer.Display.drawLine(120, 35, 115, 45, YELLOW);
  
  // Title
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(45, 110);
  M5Cardputer.Display.print("THUNDER CASTLE");
  
  // Play sound effect
  M5Cardputer.Speaker.tone(262, 200);
  delay(200);
  M5Cardputer.Speaker.tone(330, 200);
  delay(200);
  M5Cardputer.Speaker.tone(392, 200);
  delay(200);
  M5Cardputer.Speaker.tone(523, 400);
  delay(400);
  M5Cardputer.Speaker.stop();
  
  delay(2000);
  
  // Transition to main splash
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(3);
  M5Cardputer.Display.setTextColor(RED);
  M5Cardputer.Display.setCursor(50, 20);
  M5Cardputer.Display.print("ULTIMATUM");
  
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(60, 60);
  M5Cardputer.Display.print("Skeleton Key");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(80, 90);
  M5Cardputer.Display.print("Cardputer ADV");
  
  M5Cardputer.Display.setCursor(95, 110);
  M5Cardputer.Display.printf("v%s", firmwareVersion.c_str());
  
  delay(2000);
}

void showMainMenu() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(60, 5);
  M5Cardputer.Display.print("MAIN MENU");
  
  M5Cardputer.Display.drawLine(0, 25, 240, 25, WHITE);
  
  M5Cardputer.Display.setTextSize(1);
  
  // Calculate visible menu items (can fit about 8 items)
  int startIndex = max(0, currentMenuIndex - 3);
  int endIndex = min(menuItemCount, startIndex + 8);
  
  for (int i = startIndex; i < endIndex; i++) {
    int yPos = 30 + (i - startIndex) * 12;
    
    if (i == currentMenuIndex) {
      M5Cardputer.Display.fillRect(0, yPos - 2, 240, 12, WHITE);
      M5Cardputer.Display.setTextColor(BLACK);
    } else {
      M5Cardputer.Display.setTextColor(WHITE);
    }
    
    M5Cardputer.Display.setCursor(5, yPos);
    
    // Add update indicator
    if (i == 8 && updateAvailable) {
      M5Cardputer.Display.print("* ");
    }
    
    M5Cardputer.Display.print(menuItems[i]);
    
    if (i == currentMenuIndex) {
      M5Cardputer.Display.setTextColor(WHITE);
    }
  }
  
  // Instructions
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(5, 120);
  M5Cardputer.Display.print("UP/DOWN:Nav ENTER:Select");
}

void handleMainMenu() {
  // Check keyboard input
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == 'w' || key == KEY_UP) {  // UP
          currentMenuIndex = (currentMenuIndex - 1 + menuItemCount) % menuItemCount;
          showMainMenu();
          M5Cardputer.Speaker.tone(1000, 50);
        }
        else if (key == 's' || key == KEY_DOWN) {  // DOWN
          currentMenuIndex = (currentMenuIndex + 1) % menuItemCount;
          showMainMenu();
          M5Cardputer.Speaker.tone(1000, 50);
        }
        else if (key == KEY_ENTER || key == ' ') {  // SELECT
          selectMenuItem();
          M5Cardputer.Speaker.tone(1500, 100);
        }
      }
    }
  }
}

void selectMenuItem() {
  switch (currentMenuIndex) {
    case 0: currentState = RFID_CLONER; showRFIDScreen(); break;
    case 1: currentState = IR_BLASTER; showIRBlasterScreen(); break;
    case 2: currentState = IR_LEARN; showIRLearnScreen(); break;
    case 3: currentState = WIFI_SCANNER; showWiFiScannerScreen(); break;
    case 4: currentState = WIFI_DEAUTH; showWiFiDeauthScreen(); break;
    case 5: currentState = BLUETOOTH_SCANNER; showBluetoothScreen(); break;
    case 6: currentState = SIGNAL_ANALYZER; showSignalAnalyzerScreen(); break;
    case 7: currentState = AI_ASSISTANT; showAIAssistantScreen(); break;
    case 8: currentState = FIRMWARE_UPDATE; showFirmwareUpdateScreen(); break;
    case 9: currentState = SETTINGS; showSettingsScreen(); break;
    case 10: currentState = ABOUT; showAboutScreen(); break;
  }
}

// ================================================
// FEATURE SCREENS
// ================================================

void showRFIDScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("RFID CLONER");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("PN532 Module Required");
  M5Cardputer.Display.setCursor(10, 60);
  M5Cardputer.Display.print("Connect to I2C port");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 100);
  M5Cardputer.Display.print("ESC: Back to Menu");
}

void showIRBlasterScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("IR BLASTER");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  
  // Show saved IR codes
  int y = 40;
  for (size_t i = 0; i < min(irCodes.size(), (size_t)5); i++) {
    M5Cardputer.Display.setCursor(10, y);
    M5Cardputer.Display.printf("%d. %s", i+1, irCodes[i].name);
    y += 12;
  }
  
  if (irCodes.empty()) {
    M5Cardputer.Display.setCursor(10, 40);
    M5Cardputer.Display.print("No saved codes");
    M5Cardputer.Display.setCursor(10, 55);
    M5Cardputer.Display.print("Use IR Learner first");
  }
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 110);
  M5Cardputer.Display.print("1-5:Send ESC:Back");
}

void showIRLearnScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("IR LEARNER");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("Point remote at sensor");
  M5Cardputer.Display.setCursor(10, 55);
  M5Cardputer.Display.print("Press any button...");
  
  M5Cardputer.Display.setTextColor(GREEN);
  M5Cardputer.Display.setCursor(10, 80);
  M5Cardputer.Display.print("Listening...");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 110);
  M5Cardputer.Display.print("ESC: Cancel");
}

void showWiFiScannerScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("WIFI SCANNER");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("Scanning...");
  
  // Scan WiFi networks
  int n = WiFi.scanNetworks();
  
  M5Cardputer.Display.fillRect(10, 40, 220, 60, BLACK);
  
  if (n == 0) {
    M5Cardputer.Display.setCursor(10, 40);
    M5Cardputer.Display.print("No networks found");
  } else {
    int y = 40;
    for (int i = 0; i < min(n, 5); i++) {
      M5Cardputer.Display.setCursor(10, y);
      M5Cardputer.Display.printf("%s (%d)", 
        WiFi.SSID(i).c_str(), WiFi.RSSI(i));
      y += 12;
    }
    
    M5Cardputer.Display.setTextColor(GREEN);
    M5Cardputer.Display.setCursor(10, 105);
    M5Cardputer.Display.printf("Found %d networks", n);
  }
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 120);
  M5Cardputer.Display.print("ENTER:Rescan ESC:Back");
}

void showWiFiDeauthScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(RED);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("WIFI DEAUTH");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("! EDUCATIONAL ONLY !");
  
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 60);
  M5Cardputer.Display.print("Feature disabled");
  M5Cardputer.Display.setCursor(10, 75);
  M5Cardputer.Display.print("Check local laws");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 110);
  M5Cardputer.Display.print("ESC: Back to Menu");
}

void showBluetoothScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("BT SCANNER");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("Scanning BLE devices...");
  
  // Placeholder for BLE scan results
  M5Cardputer.Display.setCursor(10, 60);
  M5Cardputer.Display.print("Feature in development");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 110);
  M5Cardputer.Display.print("ESC: Back to Menu");
}

void showSignalAnalyzerScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("SIGNAL ANALYZER");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("433MHz/315MHz analyzer");
  M5Cardputer.Display.setCursor(10, 55);
  M5Cardputer.Display.print("Requires CC1101 module");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 110);
  M5Cardputer.Display.print("ESC: Back to Menu");
}

void showAIAssistantScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("DEEPSEEK AI");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  
  if (WiFi.status() != WL_CONNECTED) {
    M5Cardputer.Display.setCursor(10, 40);
    M5Cardputer.Display.print("WiFi not connected!");
    M5Cardputer.Display.setCursor(10, 55);
    M5Cardputer.Display.print("Configure in Settings");
  } else if (strlen(aiConfig.apiKey) == 0) {
    M5Cardputer.Display.setCursor(10, 40);
    M5Cardputer.Display.print("API Key not set!");
    M5Cardputer.Display.setCursor(10, 55);
    M5Cardputer.Display.print("Configure in Settings");
  } else {
    M5Cardputer.Display.setCursor(10, 40);
    M5Cardputer.Display.print("Connected to DeepSeek");
    M5Cardputer.Display.setCursor(10, 55);
    M5Cardputer.Display.printf("Model: %s", aiConfig.model);
    
    M5Cardputer.Display.setTextColor(GREEN);
    M5Cardputer.Display.setCursor(10, 75);
    M5Cardputer.Display.print("Type question & press ENTER");
  }
  
  if (aiThinking) {
    M5Cardputer.Display.setTextColor(YELLOW);
    M5Cardputer.Display.setCursor(10, 95);
    M5Cardputer.Display.print("Thinking...");
  }
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 120);
  M5Cardputer.Display.print("ESC: Back");
}

void showFirmwareUpdateScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(GREEN);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("FW UPDATE");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.printf("Current: v%s", firmwareVersion.c_str());
  
  if (WiFi.status() != WL_CONNECTED) {
    M5Cardputer.Display.setCursor(10, 60);
    M5Cardputer.Display.print("WiFi not connected!");
  } else {
    M5Cardputer.Display.setCursor(10, 60);
    if (updateAvailable) {
      M5Cardputer.Display.setTextColor(YELLOW);
      M5Cardputer.Display.print("Update available!");
    } else {
      M5Cardputer.Display.print("Latest version installed");
    }
  }
  
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 85);
  M5Cardputer.Display.print("C: Check for updates");
  M5Cardputer.Display.setCursor(10, 100);
  M5Cardputer.Display.print("U: Install update");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 120);
  M5Cardputer.Display.print("ESC: Back");
}

void showSettingsScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("SETTINGS");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.printf("WiFi: %s", 
    strlen(wifiConfig.ssid) > 0 ? wifiConfig.ssid : "Not configured");
  
  M5Cardputer.Display.setCursor(10, 55);
  M5Cardputer.Display.printf("Status: %s",
    WiFi.status() == WL_CONNECTED ? "Connected" : "Disconnected");
  
  M5Cardputer.Display.setCursor(10, 70);
  M5Cardputer.Display.printf("AI Key: %s",
    strlen(aiConfig.apiKey) > 0 ? "Configured" : "Not set");
  
  M5Cardputer.Display.setTextColor(GREEN);
  M5Cardputer.Display.setCursor(10, 90);
  M5Cardputer.Display.print("W: WiFi Config");
  M5Cardputer.Display.setCursor(10, 105);
  M5Cardputer.Display.print("A: AI Config");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 120);
  M5Cardputer.Display.print("ESC: Back");
}

void showAboutScreen() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextSize(2);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("ABOUT");
  
  M5Cardputer.Display.setTextSize(1);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 35);
  M5Cardputer.Display.print("Ultimatum Skeleton Key");
  M5Cardputer.Display.setCursor(10, 50);
  M5Cardputer.Display.printf("Version: %s", firmwareVersion.c_str());
  M5Cardputer.Display.setCursor(10, 65);
  M5Cardputer.Display.print("M5Stack Cardputer ADV");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 85);
  M5Cardputer.Display.print("Features:");
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 100);
  M5Cardputer.Display.print("DeepSeek AI Integration");
  
  M5Cardputer.Display.setTextColor(CYAN);
  M5Cardputer.Display.setCursor(10, 120);
  M5Cardputer.Display.print("ESC: Back");
}

// ================================================
// FEATURE HANDLERS
// ================================================

void handleIRBlaster() {
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          currentState = MAIN_MENU;
          showMainMenu();
          return;
        }
        
        // Send IR code based on number pressed
        if (key >= '1' && key <= '5') {
          int index = key - '1';
          if (index < irCodes.size()) {
            sendIRCode(irCodes[index]);
            M5Cardputer.Display.fillRect(10, 100, 220, 15, BLACK);
            M5Cardputer.Display.setCursor(10, 100);
            M5Cardputer.Display.setTextColor(GREEN);
            M5Cardputer.Display.printf("Sent: %s", irCodes[index].name);
          }
        }
      }
    }
  }
}

void handleIRLearn() {
  static unsigned long lastCheck = 0;
  
  if (millis() - lastCheck > 100) {
    if (irrecv.decode(&ir_results)) {
      // Save the received code
      IrCode newCode;
      newCode.value = ir_results.value;
      newCode.bits = ir_results.bits;
      newCode.protocol = ir_results.decode_type;
      sprintf(newCode.name, "Code_%d", irCodes.size() + 1);
      
      irCodes.push_back(newCode);
      
      // Display success
      M5Cardputer.Display.fillRect(10, 70, 220, 30, BLACK);
      M5Cardputer.Display.setTextColor(GREEN);
      M5Cardputer.Display.setCursor(10, 75);
      M5Cardputer.Display.print("Code learned!");
      M5Cardputer.Display.setCursor(10, 90);
      M5Cardputer.Display.printf("0x%08X", newCode.value);
      
      M5Cardputer.Speaker.tone(2000, 200);
      
      irrecv.resume();
      delay(1000);
      
      currentState = MAIN_MENU;
      showMainMenu();
    }
    lastCheck = millis();
  }
  
  // Check for cancel
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          irrecv.resume();
          currentState = MAIN_MENU;
          showMainMenu();
        }
      }
    }
  }
}

void handleWiFiScanner() {
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          currentState = MAIN_MENU;
          showMainMenu();
        } else if (key == KEY_ENTER || key == ' ') {
          showWiFiScannerScreen(); // Rescan
        }
      }
    }
  }
}

void handleWiFiDeauth() {
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          currentState = MAIN_MENU;
          showMainMenu();
        }
      }
    }
  }
}

void handleBluetoothScanner() {
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          currentState = MAIN_MENU;
          showMainMenu();
        }
      }
    }
  }
}

void handleAIAssistant() {
  static String inputBuffer = "";
  
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          inputBuffer = "";
          currentState = MAIN_MENU;
          showMainMenu();
          return;
        } else if (key == KEY_ENTER) {
          if (inputBuffer.length() > 0) {
            askDeepSeek(inputBuffer);
            inputBuffer = "";
          }
        } else if (key == 0x08) { // Backspace
          if (inputBuffer.length() > 0) {
            inputBuffer.remove(inputBuffer.length() - 1);
          }
        } else if (key >= 32 && key <= 126) { // Printable characters
          inputBuffer += (char)key;
        }
        
        // Display input buffer
        M5Cardputer.Display.fillRect(10, 90, 220, 15, BLACK);
        M5Cardputer.Display.setCursor(10, 90);
        M5Cardputer.Display.setTextColor(YELLOW);
        M5Cardputer.Display.print(inputBuffer);
      }
    }
  }
}

void handleFirmwareUpdate() {
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          currentState = MAIN_MENU;
          showMainMenu();
        } else if (key == 'c' || key == 'C') {
          checkFirmwareUpdate();
          showFirmwareUpdateScreen();
        } else if (key == 'u' || key == 'U') {
          if (updateAvailable) {
            performFirmwareUpdate();
          }
        }
      }
    }
  }
}

void handleSettings() {
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          currentState = MAIN_MENU;
          showMainMenu();
        } else if (key == 'w' || key == 'W') {
          configureWiFi();
        } else if (key == 'a' || key == 'A') {
          configureAI();
        }
      }
    }
  }
}

void handleAbout() {
  if (M5Cardputer.Keyboard.isChange()) {
    if (M5Cardputer.Keyboard.isPressed()) {
      Keyboard_Class::KeysState status = M5Cardputer.Keyboard.keysState();
      
      for (auto key : status.word) {
        if (key == KEY_ESC) {
          currentState = MAIN_MENU;
          showMainMenu();
        }
      }
    }
  }
}

// ================================================
// HELPER FUNCTIONS
// ================================================

void sendIRCode(IrCode& code) {
  switch (code.protocol) {
    case NEC:
      irsend.sendNEC(code.value, code.bits);
      break;
    case SONY:
      irsend.sendSony(code.value, code.bits);
      break;
    case RC5:
      irsend.sendRC5(code.value, code.bits);
      break;
    case RC6:
      irsend.sendRC6(code.value, code.bits);
      break;
    case SAMSUNG:
      irsend.sendSAMSUNG(code.value, code.bits);
      break;
    default:
      irsend.sendRaw((uint16_t*)&code.value, code.bits, 38);
      break;
  }
}

void loadConfigurations() {
  // Load WiFi config
  EEPROM.get(WIFI_CONFIG_START, wifiConfig);
  if ((uint8_t)wifiConfig.ssid[0] == 0xFF) {
    memset(&wifiConfig, 0, sizeof(wifiConfig));
  }
  
  // Load AI config
  EEPROM.get(AI_CONFIG_START, aiConfig);
  if ((uint8_t)aiConfig.apiKey[0] == 0xFF) {
    memset(&aiConfig, 0, sizeof(aiConfig));
    strcpy(aiConfig.model, DEEPSEEK_MODEL);
    strcpy(aiConfig.endpoint, DEEPSEEK_API_ENDPOINT);
  }
}

void saveConfigurations() {
  EEPROM.put(WIFI_CONFIG_START, wifiConfig);
  EEPROM.put(AI_CONFIG_START, aiConfig);
  EEPROM.commit();
}

void connectToWiFi() {
  if (strlen(wifiConfig.ssid) == 0) return;
  
  WiFi.begin(wifiConfig.ssid, wifiConfig.password);
  
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 50);
  M5Cardputer.Display.printf("Connecting to %s", wifiConfig.ssid);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    M5Cardputer.Display.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    M5Cardputer.Display.setTextColor(GREEN);
    M5Cardputer.Display.setCursor(10, 70);
    M5Cardputer.Display.print("Connected!");
    M5Cardputer.Speaker.tone(2000, 200);
  } else {
    M5Cardputer.Display.setTextColor(RED);
    M5Cardputer.Display.setCursor(10, 70);
    M5Cardputer.Display.print("Failed!");
    M5Cardputer.Speaker.tone(500, 500);
  }
  
  delay(1500);
}

void configureWiFi() {
  // Use keyboard input to configure WiFi
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("WiFi Configuration");
  
  // This would need a more complex text input system
  // For now, use serial configuration
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("Use Serial Monitor:");
  M5Cardputer.Display.setCursor(10, 55);
  M5Cardputer.Display.print("115200 baud");
  
  Serial.println("\n=== WiFi Configuration ===");
  Serial.println("Enter SSID:");
  while (!Serial.available()) { delay(100); }
  String ssid = Serial.readStringUntil('\n');
  ssid.trim();
  
  Serial.println("Enter Password:");
  while (!Serial.available()) { delay(100); }
  String pass = Serial.readStringUntil('\n');
  pass.trim();
  
  strncpy(wifiConfig.ssid, ssid.c_str(), 31);
  strncpy(wifiConfig.password, pass.c_str(), 63);
  
  saveConfigurations();
  
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextColor(GREEN);
  M5Cardputer.Display.setCursor(10, 50);
  M5Cardputer.Display.print("WiFi Configured!");
  
  delay(1500);
  connectToWiFi();
  
  currentState = SETTINGS;
  showSettingsScreen();
}

void configureAI() {
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(10, 10);
  M5Cardputer.Display.print("AI Configuration");
  
  M5Cardputer.Display.setTextColor(WHITE);
  M5Cardputer.Display.setCursor(10, 40);
  M5Cardputer.Display.print("Use Serial Monitor:");
  
  Serial.println("\n=== DeepSeek Configuration ===");
  Serial.println("Enter API Key:");
  while (!Serial.available()) { delay(100); }
  String apiKey = Serial.readStringUntil('\n');
  apiKey.trim();
  
  strncpy(aiConfig.apiKey, apiKey.c_str(), 63);
  saveConfigurations();
  
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextColor(GREEN);
  M5Cardputer.Display.setCursor(10, 50);
  M5Cardputer.Display.print("AI Configured!");
  
  delay(1500);
  
  currentState = SETTINGS;
  showSettingsScreen();
}

void askDeepSeek(String question) {
  if (WiFi.status() != WL_CONNECTED || strlen(aiConfig.apiKey) == 0) {
    return;
  }
  
  aiThinking = true;
  showAIAssistantScreen();
  
  HTTPClient http;
  http.begin(aiConfig.endpoint);
  http.addHeader("Content-Type", "application/json");
  http.addHeader("Authorization", String("Bearer ") + aiConfig.apiKey);
  
  JsonDocument doc;
  doc["model"] = aiConfig.model;
  
  JsonArray messages = doc["messages"].to<JsonArray>();
  JsonObject msg = messages.add<JsonObject>();
  msg["role"] = "user";
  msg["content"] = question;
  
  doc["max_tokens"] = 200;
  doc["temperature"] = 0.7;
  
  String payload;
  serializeJson(doc, payload);
  
  int httpCode = http.POST(payload);
  
  if (httpCode == 200) {
    String response = http.getString();
    JsonDocument respDoc;
    deserializeJson(respDoc, response);
    
    if (respDoc.containsKey("choices")) {
      aiResponse = respDoc["choices"][0]["message"]["content"].as<String>();
      
      // Display response
      M5Cardputer.Display.fillRect(0, 40, 240, 70, BLACK);
      M5Cardputer.Display.setCursor(10, 40);
      M5Cardputer.Display.setTextColor(GREEN);
      M5Cardputer.Display.print("Response:");
      
      M5Cardputer.Display.setCursor(10, 55);
      M5Cardputer.Display.setTextColor(WHITE);
      
      // Wrap text
      int x = 10, y = 55;
      for (int i = 0; i < min(aiResponse.length(), 150); i++) {
        if (x > 230 || aiResponse[i] == '\n') {
          x = 10;
          y += 10;
          if (y > 100) break;
        }
        M5Cardputer.Display.print(aiResponse[i]);
        x += 6;
      }
    }
  }
  
  http.end();
  aiThinking = false;
}

void checkFirmwareUpdate() {
  // Implementation for checking firmware updates
  updateAvailable = false; // Set to true if update found
}

void performFirmwareUpdate() {
  // Implementation for performing firmware update
  M5Cardputer.Display.fillScreen(BLACK);
  M5Cardputer.Display.setTextColor(YELLOW);
  M5Cardputer.Display.setCursor(30, 50);
  M5Cardputer.Display.print("Updating...");
  
  // Update logic here
  
  delay(2000);
  ESP.restart();
}
